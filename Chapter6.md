---
title: 输入输出系统
markmap:
  colorFreezeLevel: 3
---

# 输入输出系统
## I/O系统的基本功能
- 隐藏物理设备的细节
- 与设备的无关性
- 提高处理机和I/O设备的利用率
- 对I/O设备进行控制：轮询、中断、直接存储器、I/O通道
- 确保对设备的正确共享：独占设备、共享设备
- 错误处理

## I/O系统的层次结构
- 用户层软件：实现与用户交互的接口
- 设备独立性软件：实现用户程序与设备驱动器的统一接口、设备命名、设备保护
以及设备的分配与释放等，同时为设备管理和数据传送提供必要的存储空间
- 设备驱动程序：将上层发来的抽象请求转换成具体命令和参数装入设备控制器的寄存器中，或者相反
- 中断处理程序
- 接口：
    - I/O系统接口：处于I/O系统（设备独立性软件）与上层系统（用户软件）之间
    - 软件/硬件接口（RW/HW）接口：处于中断、设备驱动和设备控制器之间

## I/O系统接口
- 块设备接口
    - 块设备：数据存取和传输都是以数据块位单位的设备
    - 隐藏了磁盘的二维结构：把二维结构改变为一种线性结构
    - 将抽象命令映射为低层操作

- 流设备接口
    - 字符设备：数据的存取和传输以字符为单位
    - get和put操作
    - in-control指令

- 网络通信接口

## I/O设备
### 设备类型
- 使用特性分类：存储设备、I/O设备、交互式设备
- 传输速率分类：低速设备、中速设备、高速设备

### 设备与控制器之间的接口
- 数据信号线、控制信号线、状态信号线

## 设备控制器
### 基本功能
- 接收和识别命令：
- 数据交换：CPU-控制器、控制器-设备。数据寄存器
- 标识和报告设备状态：状态寄存器
- 地址识别：地址译码器
- 数据缓冲区
- 差错控制

### 组成
- 设备控制器与处理机的接口：数据线、地址线和控制线；数据寄存器和控制/状态寄存器
- 设备控制器与设备的接口
- I/O逻辑

### 内存映像I/O
- 利用特定的I/O指令：为每个寄存器分配一个I/O端口，访问内存和设备需要两种不同的指令
- 内存映像I/O：采用一个值的不同范围来访问内存或寄存器

### I/O通道
- 字节多路通道(Byte Multiplexor Channel)：每个设备有一个子通道，它们周期性共享一个主通道
- 数组选择通道(Block Selector Channel)：用于高速设备，但一段时间内只能执行一道通道程序，
利用率很低
- 数组多路通道(Block Multiplexor Channel)：结合了上述两种通道优点，广泛用于中高速设备

### “瓶颈”问题
- 通道不足产生的系统吞吐量下降
- 解决办法：把一个设备连接到多个控制器上，把一个控制器连接到多个通道上

## 中断机构及中断处理程序
### 中断（外中断）和陷入（内中断）(trap)
- 区别：中断来自CPU外部，陷入来自CPU内部

### 中断向量表和中断优先级

### 对多中断源的处理方式
- 屏蔽（禁止）中断
- 嵌套中断

### 中断处理程序
- 测定是否有未响应的中断信号：每当执行完一条指令后
- 保护被中断进程的CPU环境：将现场信心全部压入中断栈
- 转入相应的设备处理程序
- 中断处理：正常结束和异常结束
- 恢复CPU的现场并退出中断

## 设备驱动程序
### 功能
- 接收设备无关软件发来的命令和参数，将其转化为低层操作序列
- 检查用户I/O的合法性，了解设备工作状态，传递设备操作相关参数并设置其工作方式
- 发出I/O命令
- 及时响应由设备控制器发来的中断请求

### 特点
- 用于设备无关软件和设备控制器之间的通信和转换
- 与硬件特性紧密相关，不同类型设备需要不同类型的驱动程序，但相同的多个终端可以共用一个
- 与设备采用的控制方式紧密相关，常用中断和DMA
- 因为与硬件紧密相关，其中一部分用汇编书写
- 允许可重入

### 设备处理方式
- 为每一类设备设置一个进程
- 在整个系统中设置一个I/O进程
- 不设置专门的设备处理进程

### 驱动程序处理过程
- 将抽象要求转换为具体要求
- 对服务请求进行校验
- 检查设备状态
- 传送必要的参数
- 启动I/O设备

### 对I/O设备的控制方式
#### 轮询：处理机不断循环测试busy
#### 中断：处理机与设备并行工作，等待中断信号到来再处理数据
#### 直接存储器访问
- 特点
    - 以数据块为单位传输
    - 数据直接从设备送入内存或相反
    - 仅在开始和结束时才需要CPU干预

- DMA控制器
    - 组成：主机与DMA的接口、DMA与块设备的接口、I/O控制逻辑
    - 命令/状态寄存器CR、内存地址寄存器MAR、数据寄存器DR、数据计数器DC

#### I/O通道控制方式
- 引入：一次可以处理多个数据块而非一个
- 通道程序：操作码、内存地址、计数、通道程序结束位P、记录结束标志R

## 设备无关I/O软件(Device Independence)
### 设备无关性软件
- 设备驱动程序的统一接口：设备驱动与OS之间要有相近的接口、将
抽象设备名转换为物理设备名、对设备进行保护
- 缓冲管理
- 差错控制：暂时性错误、持久性错误
- 对独立设备的分配与回收
- 独立于设备的逻辑数据块

### 设备分配
- 设备分配中的数据结构
    - 设备控制表DCT
    - 控制器控制表COCT、通道控制表CHCT和系统设备表SDT

- 设备分配要考虑的因素
    - 设备的固有属性：独占设备、共享设备、虚拟设备
    - 设备分配算法：先来先服务、优先级
    - 安全性：“请求与保持”

- 独占设备的分配程序：分配设备、控制器、通道

### 逻辑设备名到物理设备名映射的实现
- 逻辑设备表LUT：逻辑设备名、物理设备名、驱动程序入口地址
- LUT设置方式：整个系统只设置一张、为每个用户设置一张

## 用户层的I/O软件
### 系统调用与库函数

### 假脱机(SPOOLing)系统
- 假脱机技术：利用高速磁盘设备作为中介，使用外围控制机进行处理机和设备之间的通信
- 构成
    - 输入井、输出井和井文件：井为磁盘上的区域
    - 输入缓冲区和输出缓冲区
    - 输入进程和输出进程
    - 井管理程序
- 特点
    - 提高了I/O速度
    - 将独占设备改造为共享设备
    - 实现了虚拟设备功能

### 守护进程(daemon)

## 缓冲区管理
### 引入
- 缓和CPU与I/O设备间速度不匹配的矛盾
- 减少对CPU的中断频率，放宽对CPU中断响应时间的限制
- 解决数据粒度不匹配的问题
- 提高CPU和I/O设备之间的并行性

### 单缓冲区和双缓冲区
- 设磁盘把一块数据输入缓冲区时间为T
缓冲区数据传送到用户区时间为M
CPU对数据进行处理计算时间为C
- 单缓冲区：处理时间为Max(C,T)+M
- 双缓冲区：处理时间约为Max(C,T)

### 环形缓冲区
- 组成：多个缓冲区和多个指针
- 使用：Getbuf过程、Releasebuf过程
- 进程之间同步问题：系统受计算限制、系统受I/O限制

### 缓冲池(Buffer Pool)
#### 组成
- 缓冲首部、缓冲体
- 空白缓冲队列emq、输入队列inq、输出队列outq
- 过程：Getbuf,Putbuf过程、信号量
- 工作方式：收容输入、提取输出、收容输出、提取输入

## 磁盘存储器
### 数据的组织和格式
- 存储面(Surface)、磁道(Track)、间隙(Gap)、扇区(Sectors)
- 低级格式化、高级格式化
- 扇区：标识符字段(ID Field)、数据字段(Data Field)

### 类型
- 硬盘、软盘
- 单片盘、多片盘
- 固定头磁盘、活动头磁盘

### 磁盘访问时间
- 寻道时间：$T_s=m\times n+s$
- 旋转延迟时间：$T_\tau$
- 传输时间：$T_t=\frac{b}{rN}$

### 磁盘调度算法
- 先来先服务(FCFS)
- 最短寻道时间(SSTF)
- 扫描算法(SCAN)
- 循环扫描算法(CSCAN)
- NStepSCAN和FSCAN算法
